# SOW: 「Note有料記事検索ツール v2.0」

────────────────────────────────────
## 0. 目的 / ゴール
────────────────────────────────────
- note上の公開記事から「有料記事のみ」を抽出し、スキ数（like_count）の降順で一覧化する。
- **Streamlit WebアプリとしてStreamlit Cloudにデプロイし、URLアクセスのみで利用可能にする。**
- 非稼ぐ系の調査効率を上げるため、カスタマイズ可能な除外ワードで絞り込める。

成果物:
- **Streamlit Webアプリケーション**（https://[app-name].streamlit.app）
- **ブラウザ上での結果表示**（テーブル形式、クリック可能なリンク付き）
- **CSV形式ダウンロード機能**（URL列含む）

────────────────────────────────────
## 1. 非機能要件 / 方針
────────────────────────────────────
- **個人用途・低頻度の実行を想定。大量アクセスは禁止。**
- **Web UIによる直感的な操作を重視。技術知識不要。**
- 仕様変更に備え、失敗時は graceful にスキップしログへ記録。
- レート制御: 1リクエスト毎に 800〜1200ms の待機（ジッターあり）。
- 取得上限: 初期値 200件（= 20件 × 10ページ）を上限に、設定で可変。
- 文字コード: UTF-8。
- タイムゾーン: Asia/Tokyo。日時はISO8601文字列を保持。

────────────────────────────────────
## 2. 実行イメージ（Streamlit版）
────────────────────────────────────
- **想定実装**: Streamlit Webアプリケーション
- **アクセス方法**: URLアクセスのみ（インストール・設定不要）
- **対応デバイス**: PC、スマートフォン、タブレット

### UI構成:
```
┌─────────────────────────────────────────────┐
│  📰 Note有料記事検索ツール                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                              │
│  🔍 検索設定                                  │
│  検索モード: [通常] [AND] [OR] [NOT] [カスタム]  │
│                                              │
│  検索キーワード: [_______________]             │
│                                              │
│  [▼ 詳細設定]                                │
│  ┌─────────────────────────────────────────┐│
│  │ 取得ページ数: [1---------10--------20]   ││
│  │ 価格上限: [5000] 円                     ││
│  │ 最低いいね数: [0]                       ││
│  └─────────────────────────────────────────┘│
│                                              │
│  🔎 検索クエリ: `エッセイ AND 旅行`             │
│                                              │
│  [🔍 検索実行]                               │
│                                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│  検索結果 (123件)              [📥 CSV保存]   │
│  ┌─────┬──────┬──────────────┬──────┬──────┬──────┐│
│  │いいね│ 価格  │ タイトル      │著者  │公開日 │リンク││
│  ├─────┼──────┼──────────────┼──────┼──────┼──────┤│
│  │ 523 │¥1000│エッセイ...    │user1 │01/20 │[記事]││
│  │ 412 │ ¥500│創作ノート...  │user2 │01/19 │[記事]││
│  └─────┴──────┴──────────────┴──────┴──────┴──────┘│
└─────────────────────────────────────────────┘
```

────────────────────────────────────
## 3. 主要機能
────────────────────────────────────
### 3.1 検索収集（機能拡張）
- エンドポイント: `/api/v3/searches?context=note&q={kw}&size={size}&start={start}`
- **検索演算子のサポート**：
  - AND検索: `キーワード1 AND キーワード2`
  - OR検索: `キーワード1 OR キーワード2`
  - NOT検索: `キーワード NOT 除外ワード`
  - 複合検索: `(キーワード1 OR キーワード2) AND キーワード3 NOT 除外ワード`
- ページング: size=20固定、start=0,20,40...
- 取得配列の場所: `data.notes.contents`
- 必要フィールド: name, description, price, like_count, key, publish_at, user.urlname

### 3.2 フィルタリング（仕様変更）
- **有料判定**: price > 0
- **除外処理**: NOT検索演算子を使用してAPIレベルで処理
  - **よく使われる除外ワード**: "稼ぐ,副業,収益,ビジネス,マネタイズ,集客"
  - **使用例**: `エッセイ NOT 稼ぐ NOT 副業`
  - **利点**: APIレベルでのフィルタリングにより高速化
- **追加フィルタ**:
  - 公開日範囲: 設定なし（将来拡張用）
  - 最低スキ数: like_count >= N（UI設定可能）
  - 価格上限: price <= M（UI設定可能、デフォルト5000円）

### 3.3 並べ替え・出力（機能拡張）
- **ソート**: like_count DESC, publish_at DESC（同率タイの場合）
- **画面表示**:
  1. いいね数（数値）
  2. 価格（¥表記）
  3. タイトル（テキスト）
  4. 著者（テキスト）
  5. 公開日（テキスト）
  6. **リンク（クリック可能、"記事を読む"表示）** ← 新機能
- **CSV出力**:
  1. likes
  2. price
  3. title
  4. url ← **新機能: URLも含める**
  5. author_urlname
  6. publish_at
  7. description_short
- エンコーディング: UTF-8（BOMなし）

### 3.4 エラーハンドリング（Streamlit版）
- **ユーザー向けエラー表示**: `st.error()` でわかりやすいメッセージ
- **進捗表示**: `st.progress()` でリアルタイム進捗バー
- **部分的成功**: エラー時も取得済みデータを表示・CSV出力
- **個別記事エラー**: try-except でスキップして継続処理
- 429/403/5xx: バックオフ（指数 + ジッター）で最大3回まで再試行

### 3.5 UI/UX機能
- **検索モード選択**: ラジオボタンで通常/AND/OR/NOT/カスタム検索を選択
- **検索クエリプレビュー**: 実際のAPIクエリをリアルタイム表示
- **詳細使い方ガイド**: 画面下部に検索演算子の説明を含むガイド
- **具体例提示**: 各検索モードに対応した例を掲載
- **トラブルシューティング**: よくある問題と解決方法

────────────────────────────────────
## 4. 設定仕様（Streamlit版）
────────────────────────────────────
### 4.1 UI設定項目
- **検索モード**: ラジオボタン（通常/AND/OR/NOT/カスタム）
- **検索キーワード**: モードに応じた動的入力フォーム
- **取得ページ数**: スライダー（1-20、デフォルト10）
- **価格上限**: 数値入力（デフォルト5000円、0で無制限）
- **最低いいね数**: 数値入力（デフォルト0）

### 4.2 内部設定（コード定数）
```python
COMMON_EXCLUDE_WORDS = "稼ぐ,副業,収益,ビジネス,マネタイズ,集客"
RATE_LIMIT_MIN = 800  # ms
RATE_LIMIT_MAX = 1200  # ms
MAX_PAGES = 20
ITEMS_PER_PAGE = 20
MAX_RETRIES = 3
```

────────────────────────────────────
## 5. 正常・異常系（変更なし）
────────────────────────────────────
### 5.1 正常
- 各ページの取得成功 → フィルタ → ソート → 画面表示 + CSV出力

### 5.2 異常（代表例とハンドリング）
- **400 Bad Request**: ユーザーにエラーメッセージ表示、設定見直し促進
- **403 Forbidden**: バックオフ再試行、失敗時は部分結果表示
- **404 Not Found**: 個別記事スキップして継続
- **429 Too Many Requests**: 待機時間増加して再試行
- **5xx**: 指数バックオフで再試行、最終失敗時は部分結果表示

表示方法: Streamlitの `st.error()`, `st.warning()` で直感的に表示

────────────────────────────────────
## 6. テスト観点（Streamlit版）
────────────────────────────────────
- **基本機能テスト**:
  - キーワード検索で有料記事のみ抽出される
  - 除外ワード設定が正しく適用される
  - いいね数順でソートされる
  - リンク列から記事ページにアクセスできる
- **UI/UXテスト**:
  - スマートフォンでも正常に表示・操作できる
  - 進捗バーが適切に動作する
  - エラーメッセージがわかりやすく表示される
- **CSV出力テスト**:
  - URL列が含まれている
  - 文字化けしない（UTF-8）
  - Excel等で正常に開ける
- **エラー処理テスト**:
  - ネットワークエラー時も部分結果が取得できる
  - 不正な記事データがあってもスキップして継続する

────────────────────────────────────
## 7. デプロイ・運用仕様
────────────────────────────────────
### 7.1 デプロイ環境
- **プラットフォーム**: Streamlit Cloud（無料版）
- **要件**: GitHubパブリックリポジトリ
- **URL形式**: `https://[app-name].streamlit.app`
- **自動デプロイ**: Git pushで自動更新

### 7.2 ファイル構成
```
note-like/
├── app.py                    # メインアプリケーション
├── requirements.txt          # Python依存関係
├── README.md                # プロジェクト説明
├── .gitignore               # Git除外設定
├── document/                # 仕様書
│   ├── note_paid_articles_collection_spec.md      # v1.0
│   ├── note_paid_articles_collection_spec_v2.md   # v2.0
│   └── streamlit_implementation_plan.md
└── CLAUDE.md               # 開発ガイド
```

### 7.3 運用上の注意
- **共有方法**: URLを共有するだけで利用可能
- **ユーザー要件**: ブラウザのみ（インストール不要）
- **アクセス制限**: なし（パブリックアクセス）
- **使用量制限**: Streamlit Cloud無料版の制限内

────────────────────────────────────
## 8. 検索演算子の詳細仕様
────────────────────────────────────
### 8.1 対応演算子一覧
**✅ 対応済み演算子**
- `AND`（大文字・小文字対応）: 複数条件をすべて満たす
- `OR`（大文字・小文字対応）: 複数条件のいずれかを満たす
- `NOT`（大文字・小文字対応）: 特定条件を除外
- `()`（括弧）: 演算子の優先度を制御

**❓ 動作未確認**
- `""`（ダブルクォート）: 完全一致検索（可能性あり）
- `*`, `?`（ワイルドカード）: パターンマッチング（未対応の可能性）

### 8.2 検索モード別の動作
1. **通常検索**: キーワードをそのまま検索
2. **AND検索**: `キーワード1 AND キーワード2 [AND キーワード3]`
3. **OR検索**: `キーワード1 OR キーワード2 [OR キーワード3]`
4. **NOT検索**: `メインキーワード NOT 除外1 NOT 除外2...`
5. **カスタム検索**: 自由な演算子組み合わせ

### 8.3 検索例とユースケース
```
# エッセイと旅行の両方を含む記事
エッセイ AND 旅行

# エッセイ、日記、随筆のいずれかを含む記事
エッセイ OR 日記 OR 随筆

# エッセイでビジネス系を除外
エッセイ NOT ビジネス NOT 稼ぐ NOT 副業

# 複合条件の例
(エッセイ OR 日記) AND 旅行 NOT ビジネス
```

────────────────────────────────────
## 9. v1.0からの主な変更点
────────────────────────────────────
### 9.1 実装方式の変更
- **Before**: コマンドライン実行 → CSV出力
- **After**: Webアプリ → ブラウザ表示 + CSV出力

### 9.2 UI/UX改善
- **Before**: フィルタープリセット（ゆるめ/標準/厳しめ/カスタム）
- **After**: 検索モード選択（通常/AND/OR/NOT/カスタム） + 検索演算子の活用

### 9.3 機能追加
- **新機能1**: クリック可能なリンク列（記事への直接アクセス）  
- **新機能2**: CSV出力にURL列を含める
- **新機能3**: リアルタイム進捗表示
- **新機能4**: 詳細使い方ガイド（画面内表示）
- **新機能5**: 検索演算子（AND/OR/NOT/複合）のサポート
- **新機能6**: 検索クエリのプレビュー表示

### 9.4 配布方式の変更
- **Before**: ファイル配布 + 環境構築必要
- **After**: URL共有のみ（ゼロインストール）

────────────────────────────────────
## 10. 今後の拡張（v3.0候補）
────────────────────────────────────
- **検索履歴機能**: 過去の検索条件を保存・再利用
- **お気に入り機能**: 特定の記事をマーク・管理
- **グラフ表示**: いいね数分布、価格帯分析の可視化
- **著者フォロー**: 特定著者の新着記事通知（メール等）
- **API制限緩和**: キャッシュ機構による高速化
- **フィルター高度化**: 公開日範囲、タグ指定等

────────────────────────────────────
## 11. 参考情報・出典（変更なし）
────────────────────────────────────
### note 非公式API仕様
- **API一覧とv3 /searches仕様**
  - https://note.com/ego_station/n/n85fcb635c0a9
  - v3 /searches、size/start ページング、data.notes.contents 内に price・like_count 等が含まれる例

- **主要エンドポイントの整理**
  - https://note.com/soh_ainsight/n/n80d43f9c467e
  - /v3/searches?context=note、/v2/creators/{urlname}/contents、/v3/notes/{key}、/v3/notes/{key}/likes

- **検索APIで取得できる要素**
  - https://note.com/manochi/n/n4f57e7ae7b9b
  - タイトル、作成者、公開日時、スキ数、サムネイル等の取得可能項目

### コンプライアンス関連
- **robots.txt 設定**
  - https://note.com/robots.txt
  - /api/* の Disallow 設定（一般UA）、Googlebot 例外の記載

- **非公式API利用上の注意**
  - https://note.com/manochi/n/n4f57e7ae7b9b
  - 仕様変更やアクセス頻度制限に留意すべきとの注意事項